stage('test-sgx') {

    sh '''
        if test -f "$GRAMINE_PKGLIBDIR"/runtime/glibc/libc.so.6
        then
            .ci/check-no-syscall.sh "$GRAMINE_PKGLIBDIR"/runtime/glibc/libc.so.6
        fi
        if test -f "$GRAMINE_PKGLIBDIR"/runtime/musl/libc.so
        then
            .ci/check-no-syscall.sh "$GRAMINE_PKGLIBDIR"/runtime/musl/libc.so
        fi
    '''

    if (os_release_id != "alpine") {
        try {
            timeout(time: 60, unit: 'MINUTES') {
                sh '''
                    cd libos/test/ltp
                    make ${MAKEOPTS} -f Makefile.LTP SGX=1 all
                '''
                // Run tests in a separate block, so that Jenkins measures build time and run time
                // separately
                sh '''
                    cd libos/test/ltp
                    python3 -m pytest -v  --junit-xml=ltp-sgx.xml
                '''
                /*
                sh '''
                    cd LibOS/shim/test/ltp
                    export CFG=ltp-sudo-syscalls.cfg
                    export LTPSCENARIO=$PWD/install-sgx/runtest/syscalls-sudo
                    make -f Makefile.LTP ltp-sgx_results_2.xml LTPCFG=$CFG LTPTESTFILE=$LTPSCENARIO
                '''
                */
            }
        } catch (Exception e) {
        } finally {
            archiveArtifacts 'libos/test/ltp/ltp-sgx.xml'
            junit 'libos/test/ltp/ltp-sgx.xml'
        }
    }
    
}
